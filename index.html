<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PZKGNDG5ZV"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-PZKGNDG5ZV');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€å¾®ç¨‹å¼è³‡è¨Šã€‘2026 å®¢æˆ¶æ»¿æ„åº¦èª¿æŸ¥</title>

    <!-- Open Graph / Social Media Preview -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://bocheng-oss.github.io/MP-satisfaction-questionnaire/">
    <meta property="og:title" content="ã€å¾®ç¨‹å¼è³‡è¨Šã€‘2026 å®¢æˆ¶æ»¿æ„åº¦èª¿æŸ¥">
    <meta property="og:description" content="è¦ªæ„›çš„è²´è³“æ‚¨å¥½ï¼Œæ„Ÿè¬æ‚¨å°å¾®ç¨‹å¼çš„æ”¯æŒï¼Œæ‚¨çš„å›é¥‹æ˜¯æˆ‘å€‘é€²æ­¥çš„æœ€å¤§å‹•åŠ›ã€‚èª æ‘¯é‚€è«‹æ‚¨èŠ±è²» 3~5 åˆ†é˜ç‚ºæˆ‘å€‘çš„æœå‹™æä¾›å¯¶è²´å»ºè­°ã€‚">
    <!-- âš ï¸ è«‹æ›´æ›ç‚ºæ‚¨å¯¦éš›çš„ OG åœ–ç‰‡ç¶²å€ï¼Œå»ºè­°å¤§å° 1200x630 -->
    <meta property="og:image" content="https://bocheng-oss.github.io/MP-satisfaction-questionnaire/Banner/head_zh.jpg">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ã€å¾®ç¨‹å¼è³‡è¨Šã€‘2026 å®¢æˆ¶æ»¿æ„åº¦èª¿æŸ¥">
    <meta name="twitter:description" content="æ‚¨çš„å›é¥‹æ˜¯æˆ‘å€‘é€²æ­¥çš„æœ€å¤§å‹•åŠ›ã€‚èª æ‘¯é‚€è«‹æ‚¨å¡«å¯«æ»¿æ„åº¦èª¿æŸ¥ã€‚">
    <meta name="twitter:image" content="https://bocheng-oss.github.io/MP-satisfaction-questionnaire/Banner/head_zh.jpg">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            red: '#EF4444',
                            redLight: '#FEE2E2', // red-100
                            dark: '#334155', // slate-700
                            bg: '#F8FAFC', // slate-50
                        }
                    },
                    borderRadius: {
                        'card': '2.5rem',
                    },
                    boxShadow: {
                        'soft': '0 20px 40px -10px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar for sleek look */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #CBD5E1;
            border-radius: 20px;
        }

        .fade-enter-active {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .fade-leave-active {
            animation: fadeOut 0.3s ease-in forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .question-card {
            transition: all 0.3s ease;
        }

        .option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);
        }

        .option-btn.selected {
            background-color: #FEF2F2;
            /* brand-red-50 */
            border-color: #EF4444;
            color: #EF4444;
            font-weight: 500;
        }

        /* Custom Slider (NPS) Styling */
        .slider-container {
            padding: 1rem 0.5rem;
            position: relative;
        }

        .range-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            /* slate-200 */
            border-radius: 4px;
            outline: none;
            cursor: pointer;
            touch-action: pan-y;
            /* Allow vertical scroll, prevent horizontal pan conflicts */
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            border: 3px solid #94a3b8;
            /* slate-400 */
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            margin-top: -8px;
            /* (8/2) - (24/2) = -8px to center vertically in webkit */
        }

        .range-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: white;
            border: 3px solid #94a3b8;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .range-slider::-webkit-slider-thumb:hover,
        .range-slider:active::-webkit-slider-thumb {
            transform: scale(1.1);
            border-color: #EF4444;
            /* brand-red */
        }

        /* å¾¹åº•è§£æ±º Chrome Mobile iframe æ»¾å‹•é–æ­»å•é¡Œ */
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            background: #f8fafc;
            /* brand-bg */
        }

        .scroll-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
        }
    </style>
</head>

<body class="antialiased selection:bg-brand-red selection:text-white">

    <div class="scroll-wrapper">
        <!-- Main Container -->
        <div id="app" class="w-full max-w-2xl relative">

            <!-- Header / Progress (Hidden on Intro) -->
            <div id="header-progress" class="hidden mb-8 px-4 flex items-center justify-between fade-enter-active">
                <div id="progress-container" class="flex-1 mr-6">
                    <h2 id="group-title" class="text-xs font-bold uppercase tracking-widest text-slate-400 mb-2">
                        LOADING...
                    </h2>
                    <div class="h-2 w-full bg-slate-200 rounded-full overflow-hidden">
                        <div id="progress-bar" class="h-full bg-brand-red transition-all duration-500 ease-out"
                            style="width: 0%"></div>
                    </div>
                </div>
                <div class="text-brand-red">
                    <i class="ph ph-trophy text-3xl"></i>
                </div>
            </div>

            <!-- Content Card -->
            <div
                class="bg-white rounded-card shadow-2xl p-8 md:p-12 min-h-[500px] flex flex-col relative overflow-hidden transition-all duration-500">

                <!-- Loading State -->
                <div id="loading-view" class="absolute inset-0 flex flex-col items-center justify-center bg-white z-50">
                    <div class="w-12 h-12 border-4 border-slate-100 border-t-brand-red rounded-full animate-spin"></div>
                    <p class="mt-4 text-sm font-medium text-slate-400">è¼‰å…¥ç³»çµ±ä¸­...</p>
                </div>

                <!-- Language Selection View (NEW) -->
                <div id="language-view"
                    class="hidden flex-1 flex flex-col items-center justify-center text-center fade-enter-active">
                    <div class="mb-8">
                        <i class="ph ph-translate text-6xl text-brand-red mb-4"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-slate-800 mb-4">è«‹é¸æ“‡æ‚¨çš„èªè¨€</h1>
                    <h2 class="text-2xl font-semibold text-slate-600 mb-12">Choose Your Language</h2>

                    <div class="flex flex-col gap-4 w-full max-w-md">
                        <button onclick="selectLanguage('zh')"
                            class="bg-white hover:bg-brand-red hover:text-white border-2 border-slate-200 hover:border-brand-red text-slate-700 px-10 py-6 rounded-xl font-bold text-lg tracking-wide shadow-lg hover:shadow-red-200 transition-all transform hover:-translate-y-1 active:scale-95 flex items-center justify-center gap-3 group">
                            <span class="text-2xl">ğŸ‡¹ğŸ‡¼</span>
                            <span>ç¹é«”ä¸­æ–‡</span>
                        </button>

                        <button onclick="selectLanguage('en')"
                            class="bg-white hover:bg-brand-red hover:text-white border-2 border-slate-200 hover:border-brand-red text-slate-700 px-10 py-6 rounded-xl font-bold text-lg tracking-wide shadow-lg hover:shadow-red-200 transition-all transform hover:-translate-y-1 active:scale-95 flex items-center justify-center gap-3 group">
                            <span class="text-2xl">ğŸ‡ºğŸ‡¸</span>
                            <span>English</span>
                        </button>
                    </div>
                </div>

                <!-- Intro View (New) -->
                <div id="intro-view"
                    class="hidden flex-1 flex flex-col items-center justify-center text-center fade-enter-active">
                    <div id="banner-container"
                        class="mb-8 w-[calc(100%+4rem)] -mt-8 -mx-8 md:w-[calc(100%+6rem)] md:-mt-12 md:-mx-12 overflow-hidden rounded-t-card relative min-h-[160px] bg-slate-50 flex items-center justify-center">
                        <div id="banner-loader"
                            class="absolute inset-0 flex items-center justify-center bg-slate-50 z-10">
                            <div class="w-8 h-8 border-2 border-slate-200 border-t-brand-red rounded-full animate-spin">
                            </div>
                        </div>
                        <img id="banner-img" src="" alt="Banner"
                            class="w-full h-full object-cover opacity-0 transition-opacity duration-500">
                    </div>
                    <h1 id="intro-title" class="text-2xl font-bold text-slate-800 mb-6 mt-6">ã€å¾®ç¨‹å¼è³‡è¨Šã€‘2026 å®¢æˆ¶æ»¿æ„åº¦èª¿æŸ¥</h1>
                    <div id="intro-content"
                        class="text-slate-600 mb-10 max-w-lg mx-auto leading-relaxed text-left space-y-4 text-sm md:text-base">
                        <!-- Content will be dynamically inserted -->
                    </div>
                    <button id="start-btn" onclick="startSurvey()"
                        class="bg-brand-red hover:bg-red-600 text-white px-10 py-4 rounded-xl font-bold tracking-wide shadow-lg shadow-red-200 hover:shadow-red-300 transition-all transform hover:-translate-y-1 active:scale-95 flex items-center gap-2 group">
                        <span>é–‹å§‹å¡«å¯«</span>
                        <i class="ph ph-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>

                <!-- Question View -->
                <div id="question-view" class="hidden flex-1 flex flex-col">
                    <div id="questions-container" class="flex-1 space-y-10 pb-8 fade-enter-active">
                        <!-- Dynamic Questions Injection -->
                    </div>

                    <!-- Navigation -->
                    <div class="pt-6 border-t border-slate-100 flex justify-between items-center mt-auto">
                        <button id="prev-btn"
                            class="hidden text-slate-400 hover:text-slate-600 transition-colors font-medium text-sm flex items-center gap-1 px-3 py-2">
                            <i class="ph ph-arrow-left"></i> <span>ä¸Šä¸€é </span>
                        </button>

                        <button id="next-btn"
                            class="ml-auto bg-brand-red hover:bg-red-600 text-white px-8 py-3 rounded-xl font-bold tracking-wide shadow-lg shadow-red-200 hover:shadow-red-300 transition-all transform hover:-translate-y-1 active:scale-95 flex items-center gap-2 group disabled:opacity-50 disabled:cursor-not-allowed">
                            <span>ä¸‹ä¸€é </span>
                            <i class="ph ph-arrow-right group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>
                </div>

                <!-- End View -->
                <div id="end-view" class="hidden flex-1 flex flex-col justify-start text-center fade-enter-active">
                    <!-- Final Banner -->
                    <div
                        class="w-[calc(100%+4rem)] -mt-8 -mx-8 md:w-[calc(100%+6rem)] md:-mt-12 md:-mx-12 overflow-hidden rounded-t-card relative mb-12">
                        <img src="https://drive.google.com/thumbnail?id=1UG31Jyc8eLHV67tRzmfRUJ3lVifHT4ak&sz=w1200"
                            alt="Thank You Banner" class="w-full h-auto object-cover">
                    </div>
                    <div class="px-4 pb-8">
                        <h2 id="end-title" class="text-3xl font-bold text-slate-800 mb-4">æ‚¨çš„å›é¥‹å…§å®¹æˆ‘å€‘æ”¶åˆ°äº†ï¼</h2>
                        <p id="end-text" class="text-slate-500 text-lg leading-relaxed">
                            å†æ¬¡æ„Ÿè¬æ‚¨å° <span class="text-brand-red font-bold">å¾®ç¨‹å¼è³‡è¨Š</span> çš„ä¿¡ä»»èˆ‡æ”¯æŒã€‚
                        </p>
                    </div>
                </div>

                <!-- Terminate View (NEW) -->
                <div id="terminate-view"
                    class="hidden flex-1 flex flex-col justify-start text-center fade-enter-active">
                    <div
                        class="w-[calc(100%+4rem)] -mt-8 -mx-8 md:w-[calc(100%+6rem)] md:-mt-12 md:-mx-12 overflow-hidden rounded-t-card relative mb-12">
                        <img src="https://drive.google.com/thumbnail?id=1wU9aACm2HVW8f3XzhHsGIE02MeL3SaZn&sz=w1200"
                            alt="Banner" class="w-full h-auto object-cover">
                    </div>
                    <div class="px-4">
                        <p id="terminate-text" class="text-slate-600 text-lg leading-relaxed mb-8">
                            ç”±æ–¼æ‚¨æœªåŒæ„æœ¬å…¬å¸ä½¿ç”¨å•å·ä¸­çš„å¡«ç­”è³‡æ–™é€²è¡Œç ”ç©¶åˆ†æï¼Œæ•…æå‰çµæŸæ­¤æ¬¡å•å·èª¿æŸ¥ï¼Œå†æ¬¡æ„Ÿè¬æ‚¨å° <span
                                class="text-brand-red font-bold">å¾®ç¨‹å¼è³‡è¨Š</span>
                            çš„æ”¯æŒã€‚
                        </p>
                        <div class="flex flex-col gap-4 max-w-xs mx-auto">
                            <button id="terminate-submit-btn" onclick="submitFromTerminate()"
                                class="bg-brand-red hover:bg-red-600 text-white px-8 py-3 rounded-xl font-bold tracking-wide shadow-lg shadow-red-200 hover:shadow-red-300 transition-all transform hover:-translate-y-1 active:scale-95 flex items-center justify-center gap-2 group">
                                <span>ç¢ºèªæäº¤</span>
                                <i class="ph ph-check-circle text-xl"></i>
                            </button>
                            <button id="terminate-back-btn" onclick="goBackFromTerminate()"
                                class="text-slate-400 hover:text-slate-600 transition-colors font-medium flex items-center justify-center gap-1 py-2">
                                <i class="ph ph-arrow-left"></i> <span>å›åˆ°ä¸Šä¸€é </span>
                            </button>
                        </div>
                    </div>
                </div>

            </div> <!-- Closes Content Card -->
        </div> <!-- Closes #app -->
    </div> <!-- Closes .scroll-wrapper -->

    <script>
        /* =========================================
           MOCK DATA FOR LOCAL TESTING
           (Set IS_LOCAL = false when deploying to GAS)
           ========================================= */
        var IS_LOCAL = false;
        // âš ï¸ é‡è¦ï¼šéƒ¨ç½²åˆ° GitHub Pages å¾Œï¼Œè«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨çš„ GAS éƒ¨ç½²ç¶²å€ (exec URL)
        var GAS_URL = 'https://script.google.com/macros/s/AKfycbx19gN6Z8tPinf3xwbZINbd62rjJ-30Hx87xBHa4d5O5AfNcnaCPQ3kvALWpfP-FQYM/exec';
        var API_TOKEN = 'Microprogram_Secure_2026_Key'; // å¿…é ˆèˆ‡ Code.gs ä¸€è‡´

        var MOCK_DATA = [
            {
                title: "åŸºæœ¬è³‡æ–™",
                questions: [
                    { id: "q_name", text: "è«‹å•æ‚¨çš„å§“åï¼Ÿ *", type: "text", required: true },
                    { id: "q_gender", text: "æ€§åˆ¥", type: "radio", options: ["ç”·", "å¥³", "å…¶ä»–"], required: true }
                ]
            }
        ];

        /* =========================================
           APP LOGIC
           ========================================= */
        var state = {
            groups: [],
            currentGroupIndex: 0,
            answers: {},
            historyStack: [],
            loading: true,
            language: 'zh'  // 'zh' or 'en'
        };

        // --- Initialization ---
        window.onload = function () {
            initUI();
            if (IS_LOCAL) {
                console.warn("Running in LOCAL/MOCK mode.");
                setTimeout(function () { onDataLoaded(JSON.stringify(MOCK_DATA)); }, 800);
            } else {
                fetch(GAS_URL + "?action=getQuestions&token=" + API_TOKEN)
                    .then(response => response.json())
                    .then(data => onDataLoaded(JSON.stringify(data)))
                    .catch(err => onError("ç„¡æ³•é€£ç·šè‡³å¾Œç«¯: " + err));
            }
        };

        function initUI() {
            document.getElementById('next-btn').onclick = goNext;
            document.getElementById('prev-btn').onclick = goPrev;
        }

        // --- GA4 Virtual Page Tracking ---
        function trackView(title) {
            if (typeof gtag === 'function') {
                console.log("GA4 Track View: " + title);
                gtag('event', 'page_view', {
                    page_title: title,
                    page_location: window.location.href,
                    page_path: window.location.pathname + '#' + title
                });
            }
        }

        function onDataLoaded(jsonString) {
            console.log("Data received from GAS, length: " + (jsonString ? jsonString.length : 0));
            document.getElementById('loading-view').classList.add('hidden');

            if (!jsonString) {
                onError("No data received from spreadsheet.");
                return;
            }

            try {
                state.groups = JSON.parse(jsonString);
                state.loading = false;
                console.log("Parsed groups: " + state.groups.length);
                // Show language selection first
                document.getElementById('language-view').classList.remove('hidden');
                trackView("é¸æ“‡èªè¨€");
            } catch (e) {
                console.error("Parse Error:", e);
                onError("Data parsing error: " + e.message);
            }
        }

        function loadBanner() {
            var BANNER_ID = "1wU9aACm2HVW8f3XzhHsGIE02MeL3SaZn";
            var img = document.getElementById('banner-img');
            var loader = document.getElementById('banner-loader');

            if (IS_LOCAL) {
                if (loader) loader.classList.add('hidden');
                if (img) {
                    img.src = "https://images.unsplash.com/photo-1497215728101-856f4ea42174?auto=format&fit=crop&q=80&w=1000";
                    img.classList.remove('opacity-0');
                }
                return;
            }

            var directUrl = "https://drive.google.com/thumbnail?id=" + BANNER_ID + "&sz=w1200";

            if (img) {
                img.onload = function () {
                    if (loader) loader.classList.add('hidden');
                    img.classList.remove('opacity-0');
                };
                img.onerror = function () {
                    console.warn("Direct banner load failed, falling back to GAS...");
                    fallbackToGas();
                };
                img.src = directUrl;
            }

            function fallbackToGas() {
                fetch(GAS_URL + "?action=getBanner&token=" + API_TOKEN)
                    .then(response => response.json())
                    .then(result => {
                        var base64 = result.data;
                        if (loader) loader.classList.add('hidden');
                        if (base64 && base64.indexOf("data:image") === 0 && img) {
                            img.src = base64;
                            img.classList.remove('opacity-0');
                        }
                    })
                    .catch(() => {
                        if (loader) loader.classList.add('hidden');
                    });
            }
        }

        // --- TEXT TRANSLATIONS ---
        var TRANSLATIONS = {
            zh: {
                introTitle: "ã€å¾®ç¨‹å¼è³‡è¨Šã€‘2026 å®¢æˆ¶æ»¿æ„åº¦èª¿æŸ¥",
                introContent: `
                    <p>è¦ªæ„›çš„è²´è³“æ‚¨å¥½ï¼Œ<br>æ„Ÿè¬æ‚¨åƒèˆ‡æˆ‘å€‘çš„æ»¿æ„åº¦èª¿æŸ¥ï¼Œæˆ‘å€‘èª æ‘¯åœ°å¸Œæœ›æ‚¨ä¸€åˆ‡å®‰å¥½ã€‚</p>
                    <p>å¾®ç¨‹å¼è‡´åŠ›æ–¼æä¾›å„ªè³ªæœå‹™å’Œé«˜å“è³ªç”¢å“ï¼Œæ‚¨çš„å›é¥‹å°æˆ‘å€‘è‡³é—œé‡è¦ï¼Œé€™ä»½å•å·å°‡å¹«åŠ©æˆ‘å€‘äº†è§£æ‚¨çš„è¿‘æœŸé«”é©—ï¼Œä¸¦é€²ä¸€æ­¥æ”¹é€²æˆ‘å€‘çš„æœå‹™ã€‚</p>
                    <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                        <p class="font-bold text-slate-700 mb-2">æœ¬æ¬¡èª¿æŸ¥å…±åˆ†ç‚ºå…©å¤§éƒ¨ä»½ï¼š</p>
                        <ol class="list-decimal list-inside space-y-1 text-slate-500">
                            <li>æœå‹™äº’å‹•ç¶“é©—</li>
                            <li>æœå‹™æ•´é«”æ»¿æ„åº¦</li>
                        </ol>
                    </div>
                    <p>å•å·å¡«å¯«åªéœ€ç´„ 5 åˆ†é˜ï¼Œæ„Ÿè¬æ‚¨æŠ½å‡ºå¯¶è²´çš„æ™‚é–“å‘æˆ‘å€‘åˆ†äº«æ„è¦‹ï¼</p>
                    <p class="text-right pt-4 text-xs font-medium text-slate-400">
                        å®¢æˆ¶æœå‹™åœ˜éšŠ<br>å¾®ç¨‹å¼è³‡è¨Š
                    </p>`,
                startBtn: "é–‹å§‹å¡«å¯«",
                nextBtn: "ä¸‹ä¸€é ",
                prevBtn: "ä¸Šä¸€é ",
                submitBtn: "é€å‡ºå•å·",
                submitting: "è™•ç†ä¸­...",
                terminateText: 'ç”±æ–¼æ‚¨æœªåŒæ„æœ¬å…¬å¸ä½¿ç”¨å•å·ä¸­çš„å¡«ç­”è³‡æ–™é€²è¡Œç ”ç©¶åˆ†æï¼Œæ•…æå‰çµæŸæ­¤æ¬¡å•å·èª¿æŸ¥ï¼Œå†æ¬¡æ„Ÿè¬æ‚¨å° <span class="text-brand-red font-bold">å¾®ç¨‹å¼è³‡è¨Š</span> çš„æ”¯æŒã€‚',
                terminateBackBtn: "å›åˆ°ä¸Šä¸€é ",
                terminateSubmitBtn: "ç¢ºèªæäº¤",
                resetBtn: "è¿”å›é¦–é ",
                otherPlaceholder: "è«‹å¡«å¯«...",
                loadingSystem: "è¼‰å…¥ç³»çµ±ä¸­...",
                endTitle: "æ‚¨çš„å›é¥‹å…§å®¹æˆ‘å€‘æ”¶åˆ°äº†ï¼",
                endText: 'å†æ¬¡æ„Ÿè¬æ‚¨å° <span class="text-brand-red font-bold">å¾®ç¨‹å¼è³‡è¨Š</span> çš„ä¿¡ä»»èˆ‡æ”¯æŒã€‚'
            },
            en: {
                introTitle: "Microprogram 2026 Customer Satisfaction Survey",
                introContent: `
                    <p>Hello,<br>Thank you for joining our satisfaction survey. We sincerely hope you are doing well.</p>
                    <p>Microprogram is dedicated to providing high-quality services and products, and your feedback is invaluable to us. This survey will help us understand your recent experiences and further improve our services.</p>
                    <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                        <p class="font-bold text-slate-700 mb-2">This survey consists of two main sections:</p>
                        <ol class="list-decimal list-inside space-y-1 text-slate-500">
                            <li>Service interaction experience</li>
                            <li>Overall service satisfaction</li>
                        </ol>
                    </div>
                    <p>It will only take about 5 minutes to complete, and we appreciate you taking the time to share your thoughts.</p>
                    <p class="text-right pt-4 text-xs font-medium text-slate-400">
                        Customer Service Team<br>Microprogram
                    </p>`,
                startBtn: "Start Survey",
                nextBtn: "Next",
                prevBtn: "Back",
                submitBtn: "Submit",
                submitting: "Processing...",
                terminateText: 'Since you have not agreed to our company using the survey responses for research and analysis, we will end this questionnaire survey early. Once again, thank you for your support for <span class="text-brand-red font-bold">Microprogram</span>.',
                terminateBackBtn: "Back",
                terminateSubmitBtn: "Submit",
                resetBtn: "Back to Home",
                otherPlaceholder: "Please specify...",
                loadingSystem: "Loading...",
                endTitle: "We have received your feedback!",
                endText: 'Once again, thank you for your support and trust in <span class="text-brand-red font-bold">Microprogram</span>.'
            }
        };

        function selectLanguage(lang) {
            state.language = lang;
            document.getElementById('language-view').classList.add('hidden');

            // Update UI with selected language
            var t = TRANSLATIONS[lang];
            document.getElementById('intro-title').textContent = t.introTitle;
            document.getElementById('intro-content').innerHTML = t.introContent;
            document.querySelector('#start-btn span').textContent = t.startBtn;
            document.querySelector('#prev-btn span').textContent = t.prevBtn;
            document.getElementById('terminate-text').innerHTML = t.terminateText;
            document.querySelector('#terminate-back-btn span').textContent = t.terminateBackBtn;
            document.querySelector('#terminate-submit-btn span').textContent = t.terminateSubmitBtn;
            document.getElementById('end-title').textContent = t.endTitle;
            document.getElementById('end-text').innerHTML = t.endText;

            document.getElementById('intro-view').classList.remove('hidden');
            var introTitle = state.language === 'en' ? "å•å·èªªæ˜(è‹±æ–‡)" : "å•å·èªªæ˜(ä¸­æ–‡)";
            trackView(introTitle);
            loadBanner();
        }

        function startSurvey() {
            document.getElementById('intro-view').classList.add('hidden');
            document.getElementById('question-view').classList.remove('hidden');
            document.getElementById('header-progress').classList.remove('hidden');
            renderGroup(0);
        }

        function onError(msg) {
            alert("Error: " + msg);
            var p = document.querySelector('#loading-view p');
            if (p) {
                p.textContent = state.language === 'en' ? "An error occurred, please refresh" : "ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†";
                p.classList.add('text-red-500');
            }
        }

        function renderGroup(index) {
            var container = document.getElementById('questions-container');
            var groupTitleEl = document.getElementById('group-title');
            var progressBar = document.getElementById('progress-bar');

            container.innerHTML = '';
            container.classList.remove('fade-enter-active');
            void container.offsetWidth;
            container.classList.add('fade-enter-active');

            var isEn = state.language === 'en';
            var group = state.groups[index];
            state.currentGroupIndex = index;

            groupTitleEl.textContent = (isEn ? group.titleEn : group.title) || ("STEP " + (index + 1));

            var totalGroups = state.groups.length;
            var progress = (index / totalGroups) * 100;
            progressBar.style.width = (progress > 10 ? progress : 10) + "%";

            for (var i = 0; i < group.questions.length; i++) {
                container.appendChild(createQuestionElement(group.questions[i]));
            }

            document.getElementById('prev-btn').classList.toggle('hidden', state.historyStack.length === 0);

            var isLast = isLastGroup(index);
            var nextBtnSpan = document.querySelector('#next-btn span');
            var t = TRANSLATIONS[state.language];
            if (nextBtnSpan) {
                nextBtnSpan.textContent = isLast ? t.submitBtn : t.nextBtn;
            }

            validateCurrentGroup();

            // GA4 Tracking for Groups
            var isEn = state.language === 'en';
            var groupSuffix = isEn ? "(è‹±æ–‡)" : "(ä¸­æ–‡)";
            // å„ªå…ˆä½¿ç”¨ groupIdï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ index
            var groupLabel = group.id || ("g" + index);
            trackView(groupLabel + groupSuffix);
        }

        function createQuestionElement(q) {
            var wrapper = document.createElement('div');
            wrapper.className = "question-card space-y-3";

            var isEn = state.language === 'en';
            var qText = isEn ? q.textEn : q.text;
            var qDesc = isEn ? q.descriptionEn : q.description;

            var label = document.createElement('label');
            label.className = "block text-lg font-bold text-slate-700";
            label.innerHTML = qText.replace(/\n/g, '<br>') + " " + (q.required ? '<span class="text-red-500">*</span>' : '');
            wrapper.appendChild(label);

            if (qDesc) {
                var desc = document.createElement('p');
                desc.className = "text-sm text-slate-400 mt-1 leading-relaxed";
                desc.innerHTML = qDesc.replace(/\n/g, '<br>');
                wrapper.appendChild(desc);
            }

            var inputEl;

            if (q.type === 'radio' || q.type === 'å–®é¸') {
                var optionsContainer = document.createElement('div');
                optionsContainer.className = "grid grid-cols-1 gap-3 mt-2";

                var t = TRANSLATIONS[state.language];

                for (var i = 0; i < q.options.length; i++) {
                    (function (opt, index) {
                        var isEn = state.language === 'en';
                        var optLabel = isEn ? (q.optionsEn[index] || opt) : opt;

                        var isOther = opt === 'å…¶ä»–' || opt.indexOf('å…¶ä»–ï¼š') === 0;
                        var btn = document.createElement('div');
                        btn.className = "option-btn cursor-pointer border-2 border-slate-100 rounded-xl p-4 text-slate-600 transition-all flex items-center gap-3 bg-white";

                        var currentVal = state.answers[q.id] || '';
                        var isSel = false;

                        // Check if current answer matches this option
                        if (isOther) {
                            var isKnownOpt = false;
                            for (var k = 0; k < q.options.length; k++) {
                                if (q.options[k] !== opt && q.options[k] === currentVal) {
                                    isKnownOpt = true;
                                    break;
                                }
                            }
                            isSel = currentVal !== '' && !isKnownOpt;
                        } else {
                            isSel = currentVal === opt;
                        }

                        if (isSel) btn.classList.add('selected');

                        btn.onclick = function (e) {
                            if (e.target.tagName === 'INPUT') return;

                            var children = optionsContainer.children;
                            for (var j = 0; j < children.length; j++) {
                                var child = children[j];
                                child.classList.remove('selected');
                                var dot = child.querySelector('.dot-inner');
                                if (dot) {
                                    dot.classList.add('opacity-0');
                                    dot.classList.remove('opacity-100');
                                }
                            }

                            this.classList.add('selected');
                            var myDot = this.querySelector('.dot-inner');
                            if (myDot) {
                                myDot.classList.remove('opacity-0');
                                myDot.classList.add('opacity-100');
                            }

                            if (isOther) {
                                var otherInput = this.querySelector('.other-input');
                                if (otherInput) {
                                    otherInput.focus();
                                    state.answers[q.id] = otherInput.value;
                                }
                            } else {
                                state.answers[q.id] = opt; // Store the original ZH value
                            }
                            validateCurrentGroup();
                        };

                        var circleHtml = '<div class="w-5 h-5 rounded-full border-2 border-current flex items-center justify-center shrink-0">' +
                            '<div class="dot-inner w-2.5 h-2.5 rounded-full bg-brand-red transition-opacity ' + (isSel ? 'opacity-100' : 'opacity-0') + '"></div>' +
                            '</div>';

                        if (isOther) {
                            var otherDisplay = optLabel;
                            if (otherDisplay.indexOf('ï¼š') === -1 && otherDisplay.indexOf(':') === -1) {
                                otherDisplay += (isEn ? ': ' : 'ï¼š');
                            }
                            var otherVal = isSel ? currentVal : '';
                            btn.innerHTML = circleHtml + ' <span class="shrink-0">' + otherDisplay + '</span>' +
                                '<input type="text" class="other-input flex-1 min-w-0 border-b border-slate-300 focus:border-brand-red outline-none px-1 text-slate-600 bg-transparent" placeholder="' + t.otherPlaceholder + '" value="' + otherVal + '">';

                            var input = btn.querySelector('.other-input');
                            input.oninput = function () {
                                if (btn.classList.contains('selected')) {
                                    state.answers[q.id] = this.value;
                                    validateCurrentGroup();
                                }
                            };
                            // Stop propagation for click/touch in input to prevent de-selecting option
                            input.onclick = function (e) { e.stopPropagation(); };
                            input.ontouchstart = function (e) { e.stopPropagation(); };
                        } else {
                            btn.innerHTML = circleHtml + ' <span>' + optLabel + '</span>';
                        }
                        optionsContainer.appendChild(btn);
                    })(q.options[i], i);
                }
                inputEl = optionsContainer;
            } else if (q.type === 'slider' || q.type === 'é‡è¡¨' || q.type === 'è©•åˆ†') {
                // Adjust label for Slider (NPS) - add red accent bar (Corporate Brand)
                label.className = "block text-2xl font-bold text-slate-700 border-l-8 border-[#EF4444] pl-4 py-1 mb-6 mt-4";

                var sliderWrapper = document.createElement('div');
                sliderWrapper.className = "slider-container w-full py-4";

                var min = 0;
                var max = 10;

                // è®€å–æ—¢æœ‰ç­”æ¡ˆï¼Œè‹¥ç„¡å‰‡è¨­ç‚ºç©ºå­—ä¸²ä»¥é¡¯ç¤º '?'
                var savedVal = state.answers[q.id];
                var hasValue = (savedVal !== undefined && savedVal !== null && savedVal !== '');
                var displayVal = hasValue ? savedVal : '?';
                var sliderVal = hasValue ? savedVal : 0;

                var valueDisplay = document.createElement('div');
                valueDisplay.className = "text-left text-2xl font-medium text-[#EF4444] mb-8 transition-all px-1";
                valueDisplay.textContent = displayVal;

                var inputRange = document.createElement('input');
                inputRange.type = "range";
                inputRange.min = min;
                inputRange.max = max;
                inputRange.value = sliderVal;
                inputRange.className = "range-slider mb-4";

                // è¨­å®šåˆå§‹é€²åº¦æ¢é¡è‰²ï¼šè‹¥æœªå¡«å¯«å‰‡å…¨ç° (0%)
                var percent = hasValue ? (sliderVal * 10) : 0;
                inputRange.style.background = 'linear-gradient(to right, #EF4444 ' + percent + '%, #e2e8f0 ' + percent + '%)';

                var labelsRow = document.createElement('div');
                labelsRow.className = "flex justify-between text-slate-300 font-bold px-1 text-base";
                labelsRow.innerHTML = '<span>' + min + '</span><span>' + max + '</span>';

                inputRange.oninput = function () {
                    valueDisplay.textContent = this.value;
                    state.answers[q.id] = this.value;
                    var p = (this.value * 10);
                    this.style.background = 'linear-gradient(to right, #EF4444 ' + p + '%, #e2e8f0 ' + p + '%)';
                    validateCurrentGroup();
                };

                inputRange.onchange = inputRange.oninput;


                sliderWrapper.appendChild(valueDisplay);
                sliderWrapper.appendChild(inputRange);
                sliderWrapper.appendChild(labelsRow);
                inputEl = sliderWrapper;
            } else if (q.type === 'textarea' || q.type === 'æ®µè½') {
                inputEl = document.createElement('textarea');
                inputEl.className = "w-full p-4 border-2 border-slate-100 rounded-xl focus:border-brand-red focus:ring-0 outline-none transition-colors min-h-[120px] resize-none text-slate-600";
                inputEl.placeholder = state.language === 'en' ? "Please type here..." : "è«‹åœ¨æ­¤è¼¸å…¥...";
                inputEl.value = state.answers[q.id] || '';
                inputEl.oninput = function (e) {
                    state.answers[q.id] = e.target.value;
                    validateCurrentGroup();
                };
            } else {
                inputEl = document.createElement('input');
                inputEl.type = "text";
                inputEl.className = "w-full p-4 border-2 border-slate-100 rounded-xl focus:border-brand-red focus:ring-0 outline-none transition-colors text-slate-600";
                inputEl.placeholder = state.language === 'en' ? "Please enter..." : "è«‹è¼¸å…¥...";
                inputEl.value = state.answers[q.id] || '';
                inputEl.oninput = function (e) {
                    state.answers[q.id] = e.target.value;
                    validateCurrentGroup();
                };
            }

            wrapper.appendChild(inputEl);
            return wrapper;
        }

        function validateCurrentGroup() {
            var currentGroup = state.groups[state.currentGroupIndex];
            var questions = currentGroup.questions;
            var isValid = true;
            for (var i = 0; i < questions.length; i++) {
                var q = questions[i];
                if (q.required) {
                    var val = state.answers[q.id];
                    if (!val || val.toString().trim() === '') {
                        isValid = false;
                        break;
                    }
                }
            }

            var nextBtn = document.getElementById('next-btn');
            nextBtn.disabled = !isValid;
            if (isValid) {
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            return isValid;
        }

        function goNext() {
            if (!validateCurrentGroup()) return;

            var currentGroup = state.groups[state.currentGroupIndex];
            var jumpTarget = null;

            for (var i = 0; i < currentGroup.questions.length; i++) {
                var q = currentGroup.questions[i];
                if (q.logic) {
                    var ans = state.answers[q.id];
                    if (ans && q.logic[ans]) {
                        jumpTarget = q.logic[ans];
                        break;
                    } else if (q.logic["Default"]) {
                        if (!jumpTarget) jumpTarget = q.logic["Default"];
                    }
                }
            }

            if (jumpTarget === "Submit" || jumpTarget === "End" || jumpTarget === "å®Œæˆ") {
                submitForm();
                return;
            }

            if (jumpTarget === "Termination" || jumpTarget === "ä¸­æ­¢" || jumpTarget === "çµæŸ") {
                showTerminateScreen();
                return;
            }

            var nextIndex = -1;
            if (jumpTarget) {
                for (var j = 0; j < state.groups.length; j++) {
                    if (state.groups[j].id === jumpTarget) {
                        nextIndex = j;
                        break;
                    }
                }
            }

            if (nextIndex === -1) {
                nextIndex = state.currentGroupIndex + 1;
            }

            if (nextIndex < state.groups.length) {
                state.historyStack.push(state.currentGroupIndex);
                renderGroup(nextIndex);
                document.querySelector('.scroll-wrapper').scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                submitForm();
            }
        }

        function goPrev() {
            if (state.historyStack.length > 0) {
                var prevIndex = state.historyStack.pop();
                renderGroup(prevIndex);
                document.querySelector('.scroll-wrapper').scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function submitForm(sourceBtnId) {
            var t = TRANSLATIONS[state.language];
            var btnId = sourceBtnId || 'next-btn';
            var btn = document.getElementById(btnId);
            var originalContent = btn.innerHTML;

            // Set loading state
            btn.innerHTML = '<i class="ph ph-spinner animate-spin text-xl"></i> ' + t.submitting;
            btn.disabled = true;

            // Prepare payload
            var payload = JSON.parse(JSON.stringify(state.answers));
            payload["æ“ä½œèªè¨€"] = state.language === 'en' ? 'English' : 'ç¹é«”ä¸­æ–‡';
            payload["token"] = API_TOKEN; // å¸¶å…¥æš—è™Ÿ

            if (!IS_LOCAL) {
                // ä½¿ç”¨ fetch POST è‡³ GAS
                fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors', // é‡è¦ï¼šé¿å… CORS Preflight ä¸¦å…è¨±è½‰å‘
                    body: JSON.stringify(payload)
                })
                    .then(() => {
                        // æ³¨æ„ï¼šno-cors æœƒå°è‡´ response ç‚º opaque ç„¡æ³•è®€å–å…§å®¹
                        // ä½†é€šå¸¸åªè¦æˆåŠŸè½‰å‘å®Œæˆå¯«å…¥ï¼Œæˆ‘å€‘å°±å‡è¨­æˆåŠŸä¸¦é¡¯ç¤ºæ„Ÿè¬é 
                        showEndScreen();
                    })
                    .catch(err => {
                        var errMsg = state.language === 'en' ? "Submission failed: " : "æäº¤å¤±æ•—: ";
                        alert(errMsg + err);
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                    });
            } else {
                setTimeout(function () {
                    console.log("Submitted Payload:", payload);
                    showEndScreen();
                }, 1000);
            }
        }

        function submitFromTerminate() {
            submitForm('terminate-submit-btn');
        }

        function goBackFromTerminate() {
            document.getElementById('terminate-view').classList.add('hidden');
            document.getElementById('question-view').classList.remove('hidden');
            document.getElementById('header-progress').classList.remove('hidden');
            // Re-render current group to ensure UI is fresh
            renderGroup(state.currentGroupIndex);
        }

        function showEndScreen() {
            document.getElementById('question-view').classList.add('hidden');
            document.getElementById('terminate-view').classList.add('hidden');
            document.getElementById('end-view').classList.remove('hidden');
            document.getElementById('header-progress').classList.add('hidden');
            var endTitle = state.language === 'en' ? "çµæŸé (è‹±æ–‡)" : "çµæŸé (ä¸­æ–‡)";
            trackView(endTitle);
        }

        function showTerminateScreen() {
            document.getElementById('question-view').classList.add('hidden');
            document.getElementById('terminate-view').classList.remove('hidden');
            document.getElementById('header-progress').classList.add('hidden');
            var termTitle = state.language === 'en' ? "ä¸­æ­¢é (è‹±æ–‡)" : "ä¸­æ­¢é (ä¸­æ–‡)";
            trackView(termTitle);
        }

        function resetSurvey() {
            // Hide all potential views
            var views = ['question-view', 'end-view', 'terminate-view', 'header-progress'];
            for (var i = 0; i < views.length; i++) {
                var el = document.getElementById(views[i]);
                if (el) el.classList.add('hidden');
            }

            // Reset state
            state.currentGroupIndex = 0;
            state.answers = {};
            state.historyStack = [];

            // Show intro
            document.getElementById('intro-view').classList.remove('hidden');

            // Reset progress bar visually
            var progressBar = document.getElementById('progress-bar');
            if (progressBar) progressBar.style.width = '0%';
        }

        function isLastGroup(index) {
            return index === state.groups.length - 1;
        }

    </script>
</body>

</html>
